<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thingamagen</title>
  <script src="./genathing.js" defer></script>
  <link rel="stylesheet" href="./style.css" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
    .toolbar { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 12px; }
    #drawing { border: 1px solid #ddd; touch-action: none; /* needed for pointer events to block panning */ }
    label { font-size: 14px; }
    .value { min-width: 2ch; text-align: right; display: inline-block; }
  </style>
</head>

<body>
  <h1>Thingamagen</h1>

  <div id="genDisplay" class="important" style="margin-bottom: 8px;">
    Your Thingamagen will appear here.
  </div>

  <div class="toolbar">
    <button class="button" id="genBtn" onclick="genathingFn()">Generate my thing!</button>

    <!-- Toggle text visibility -->
    <button class="button" id="toggleButton" onclick="toggleTextVisibility()">Hide text</button>

    <!-- Color -->
    <label for="color">Choose a color:</label>
    <input type="color" id="color" value="#000000" />

    <!-- Thickness -->
    <label for="lineThickness">Line Thickness:</label>
    <input type="range" id="lineThickness" min="1" max="40" value="5" />
    <span class="value" id="thicknessValue">5</span>
  </div>

  <!-- Canvas -->
  <canvas id="drawing" width="1200" height="1200" tabindex="0"></canvas>

  <script>
    // --- Elements ---
    const canvas = document.getElementById("drawing");
    const ctx = canvas.getContext("2d");
    const colorPicker = document.getElementById("color");
    const lineThicknessSlider = document.getElementById("lineThickness");
    const thicknessValue = document.getElementById("thicknessValue");
    const toggleButton = document.getElementById("toggleButton");
    const genDisplay = document.getElementById("genDisplay");

    // --- Canvas drawing style ---
    ctx.strokeStyle = colorPicker.value;
    ctx.lineWidth = parseFloat(lineThicknessSlider.value);
    ctx.lineJoin = "round";
    ctx.lineCap  = "round";

    // Show initial thickness number
    thicknessValue.textContent = lineThicknessSlider.value;

    // --- Helpers ---
    function getCanvasPos(evt) {
      const rect = canvas.getBoundingClientRect();
      const x = (evt.clientX - rect.left) * (canvas.width / rect.width);
      const y = (evt.clientY - rect.top)  * (canvas.height / rect.height);
      return { x, y };
    }

    // --- Pointer drawing (mouse + touch unified) ---
    let isDrawing = false;
    let last = { x: 0, y: 0 };

    canvas.addEventListener("pointerdown", (e) => {
      // For touch, stop page from scrolling
      if (e.pointerType === "touch") e.preventDefault();
      canvas.setPointerCapture(e.pointerId);
      isDrawing = true;
      last = getCanvasPos(e);
    }, { passive: false });

    canvas.addEventListener("pointermove", (e) => {
      if (!isDrawing) return;
      if (e.pointerType === "touch") e.preventDefault();
      const pos = getCanvasPos(e);
      ctx.beginPath();
      ctx.moveTo(last.x, last.y);
      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();
      last = pos;
    }, { passive: false });

    function endStroke(e) {
      if (isDrawing) {
        isDrawing = false;
        if (e && e.pointerId) {
          try { canvas.releasePointerCapture(e.pointerId); } catch(_) {}
        }
      }
    }
    canvas.addEventListener("pointerup", endStroke);
    canvas.addEventListener("pointercancel", endStroke);
    canvas.addEventListener("pointerleave", endStroke);

    // --- Color picker: update + dismiss ---
    // Use `input` for live update; blur + focus canvas to close pickers consistently.
    colorPicker.addEventListener("input", (e) => {
      ctx.strokeStyle = e.target.value;
    });

    colorPicker.addEventListener("change", () => {
      // Try to dismiss native picker and return focus to canvas
      colorPicker.blur();
      canvas.focus();
    });

    // Some browsers (and user flows) benefit from explicit call:
    function dismissColorPicker() {
      ctx.strokeStyle = colorPicker.value;
      colorPicker.blur();
      canvas.focus();
    }
    // If you still call onchange="dismissColorPicker()" in HTML, it will work.

    // --- Line thickness slider ---
    lineThicknessSlider.addEventListener("input", (e) => {
      const v = parseFloat(e.target.value);
      ctx.lineWidth = v;
      thicknessValue.textContent = v;
    });

    // --- Toggle text visibility (use visibility per your request) ---
    // When hidden: button text becomes "Show my thing!"
    function toggleTextVisibility() {
      const hidden = genDisplay.style.visibility === "hidden";
      if (hidden) {
        genDisplay.style.visibility = "visible";
        toggleButton.textContent = "Hide text";
      } else {
        genDisplay.style.visibility = "hidden";
        toggleButton.textContent = "Show my thing!";
      }
    }
    // Expose for inline onclick
    window.toggleTextVisibility = toggleTextVisibility;

    // Optional: resize canvas visually but keep resolution (not required)
    // function fitCanvasToParent() {
    //   const maxW = Math.min(window.innerWidth - 32, 1200);
    //   canvas.style.width = maxW + "px";
    //   canvas.style.height = "auto";
    // }
    // window.addEventListener("resize", fitCanvasToParent);
    // fitCanvasToParent();
  </script>
</body>
</html>
